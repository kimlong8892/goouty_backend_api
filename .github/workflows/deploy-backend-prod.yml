name: Deploy Backend Prod

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PROD
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cloudflared, sshpass and jq
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          sudo apt-get update && sudo apt-get install -y sshpass jq

      - name: Generate .env.prod
        id: gen_env
        env:
          ALL_SECRETS: ${{ toJson(secrets) }}
          ALL_VARS: ${{ toJson(vars) }}
        run: |
          # Load public variables from repository JSON
          jq -r 'to_entries | .[] | "\(.key)=\(.value)"' .github/env-config/prod/env.json > .env.prod
          
          # Load secrets and env vars from GitHub Environments using mapping JSON
          jq -n --argjson secrets "$ALL_SECRETS" --argjson vars "$ALL_VARS" --argjson mapping "$(cat .github/env-config/prod/secrets.json)" '
            $mapping | to_entries | .[] | 
            .key as $k | .value as $v |
            ($secrets[$v] // $vars[$v]) as $val |
            if $val != null then "\($k)=\($val)" else empty end
          ' -r >> .env.prod
          
          # Handle optional bulk secret
          if [ ! -z "${{ secrets.BE_ENV_SECRET }}" ]; then
            echo "${{ secrets.BE_ENV_SECRET }}" >> .env.prod
          fi

      - name: Run Deploy Script
        run: |
          # Use Environment-level secrets (prioritize specific first, then generic)
          SSH_PASS="${{ secrets.SSH_PASSWORD_PROD }}"
          [ -z "$SSH_PASS" ] && SSH_PASS="${{ secrets.SSH_PASSWORD }}"
          
          SSH_USER="${{ secrets.SSH_USER_PROD }}"
          [ -z "$SSH_USER" ] && SSH_USER="${{ secrets.SSH_USER }}"
          
          SSH_HOST="${{ secrets.SSH_HOST_PROD }}"
          [ -z "$SSH_HOST" ] && SSH_HOST="${{ secrets.SSH_HOST }}"
          
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH_PROD }}"
          [ -z "$DEPLOY_PATH" ] && DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o "ProxyCommand=cloudflared access ssh --hostname %h" $SSH_USER@$SSH_HOST "
            # Auto-install Docker if missing
            if ! command -v docker &> /dev/null; then
              echo 'Docker not found. Installing...'
              if ! command -v curl &> /dev/null; then
                echo '$SSH_PASS' | sudo -S apt-get update && echo '$SSH_PASS' | sudo -S apt-get install -y curl
              fi
              curl -fsSL https://get.docker.com -o get-docker.sh
              echo '$SSH_PASS' | sudo -S sh get-docker.sh
              echo '$SSH_PASS' | sudo -S usermod -aG docker $SSH_USER
              rm get-docker.sh
            fi
            
            # Ensure deployment directory exists
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH
            # Fix permissions (Docker containers might have created files as root)
            echo '$SSH_PASS' | sudo -S chown -R $SSH_USER:$SSH_USER .
            git fetch origin prod
            git reset --hard origin/prod
          "
          
          # Upload .env.prod
          sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no -o "ProxyCommand=cloudflared access ssh --hostname %h" .env.prod $SSH_USER@$SSH_HOST:$DEPLOY_PATH/.env.prod
          
          # Run the deploy script
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -o "ProxyCommand=cloudflared access ssh --hostname %h" $SSH_USER@$SSH_HOST "
            cd $DEPLOY_PATH
            echo 'Deploying Backend Prod...'
            chmod +x deploy_cicd_prod.sh
            ./deploy_cicd_prod.sh
            
            echo 'Waiting for containers to start...'
            sleep 10
            
            echo 'Running database migrations...'
            docker compose -p goouty-api-prod exec -T app npx prisma migrate deploy
            
            # Run seed only if database is empty
            echo 'Checking if database needs seeding...'
            docker compose -p goouty-api-prod exec -T app npm run seed:conditional
            
            echo '--- Container Logs ---'
            docker compose -p goouty-api-prod logs --tail=50
          "
