generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid()) @db.Uuid
  email               String               @unique
  password            String?
  fullName            String?
  phoneNumber         String?
  profilePicture      String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  bankId              String?
  bankNumber          String?
  notificationsEnabled Boolean             @default(true)
  paidExpenses        Expense[]            @relation("ExpensePayer")
  expenseParticipants ExpenseParticipant[]
  creditorSettlements PaymentSettlement[]  @relation("PaymentCreditor")
  debtorSettlements   PaymentSettlement[]  @relation("PaymentDebtor")
  transactionsFrom    PaymentTransaction[] @relation("TransactionsFromUser")
  transactionsTo      PaymentTransaction[] @relation("TransactionsToUser")
  socialAccounts      SocialAccount[]
  trips               Trip[]
  tripMembers         TripMember[]
  devices             Device[]
  notifications       Notification[]
  tripTemplates       TripTemplate[]
  resetPasswordToken  String?
  resetPasswordExpires DateTime?
}

model Trip {
  id                 String              @id @default(uuid()) @db.Uuid
  title              String
  provinceId         String?             @db.Uuid
  startDate          DateTime?
  description        String?
  avatar             String?             // S3 URL for trip avatar
  shareToken         String?             @unique
  isPublic           Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime?           @updatedAt
  userId             String              @db.Uuid   // üëà th√™m @db.Uuid
  days               Day[]
  expenses           Expense[]
  paymentSettlements PaymentSettlement[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  members            TripMember[]
  province           Province?          @relation(fields: [provinceId], references: [id], onDelete: SetNull)

  @@index([provinceId])
}

model Day {
  id          String     @id @default(uuid()) @db.Uuid
  title       String
  description String?
  date        DateTime
  startTime   DateTime?
  tripId      String  @db.Uuid
  activities  Activity[]
  trip        Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
}

model TripMember {
  id        String   @id @default(uuid()) @db.Uuid
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String?  @db.Uuid  // Nullable ƒë·ªÉ h·ªó tr·ª£ invitation cho email ch∆∞a t·ªìn t·∫°i
  tripId    String  @db.Uuid
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Invitation flow
  status       String   @default("accepted") // 'pending' | 'accepted'
  inviteToken  String?  @unique
  invitedAt    DateTime?
  invitedById  String?  @db.Uuid
  invitedEmail String?  // Email c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi (khi user ch∆∞a t·ªìn t·∫°i)

  @@unique([userId, tripId])
  @@index([invitedEmail, tripId])
}

model Activity {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  startTime   DateTime?
  durationMin Int?
  location    String?
  notes       String?
  important   Boolean   @default(false)
  dayId       String  @db.Uuid
  day         Day       @relation(fields: [dayId], references: [id], onDelete: Cascade)
}

model Expense {
  id           String               @id @default(uuid()) @db.Uuid
  title        String
  amount       Decimal              @db.Decimal(20, 2)
  date         DateTime
  description  String?
  isLocked     Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  tripId       String               @db.Uuid
  payerId      String               @db.Uuid
  payer        User                 @relation("ExpensePayer", fields: [payerId], references: [id], onDelete: Cascade)
  trip         Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participants ExpenseParticipant[]
}

model ExpenseParticipant {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now())
  expenseId String   @db.Uuid
  userId    String   @db.Uuid
  amount    Decimal  @db.Decimal(20, 2)
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([expenseId, userId])
}

model SocialAccount {
  id         String   @id @default(uuid()) @db.Uuid
  provider   String
  providerId String
  email      String
  name       String?
  picture    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([provider, email])
}

model PaymentSettlement {
  id           String               @id @default(uuid()) @db.Uuid
  amount       Decimal              @db.Decimal(10, 2)
  status       String               @default("pending")
  description  String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  settledAt    DateTime?
  tripId       String               @db.Uuid
  debtorId     String               @db.Uuid
  creditorId   String               @db.Uuid
  creditor     User                 @relation("PaymentCreditor", fields: [creditorId], references: [id], onDelete: Cascade)
  debtor       User                 @relation("PaymentDebtor", fields: [debtorId], references: [id], onDelete: Cascade)
  trip         Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  transactions PaymentTransaction[]

  @@unique([tripId, debtorId, creditorId], name: "trip_debtor_creditor_unique")
}

model PaymentTransaction {
  id           String            @id @default(uuid()) @db.Uuid
  amount       Decimal           @db.Decimal(10, 2)
  status       String            @default("success")
  method       String?
  note         String?
  createdAt    DateTime          @default(now())
  settlementId String            @db.Uuid
  fromUserId   String            @db.Uuid
  toUserId     String            @db.Uuid
  fromUser     User              @relation("TransactionsFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  settlement   PaymentSettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  toUser       User              @relation("TransactionsToUser", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([settlementId])
}

model Device {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @db.Uuid
  deviceId         String   // Unique identifier for the device (browser fingerprint, etc.)
  deviceName       String?  // User-friendly name for the device
  userAgent        String?  // Browser user agent
  pushSubscription String?  // Push subscription JSON string
  isActive         Boolean  @default(true)
  lastSeen         DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([userId])
}

model Notification {
  id          String            @id @default(uuid()) @db.Uuid
  userId      String            @db.Uuid
  title       String
  body        String
  type        NotificationType  @default(INFO)
  status      NotificationStatus @default(UNREAD)
  data        Json?             // Additional data (URL, metadata, etc.)
  sentAt      DateTime?         // When notification was sent
  readAt      DateTime?         // When user read the notification
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([type])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  TRIP_CREATED
  TRIP_UPDATED
  TRIP_DELETED
  EXPENSE_ADDED
  EXPENSE_UPDATED
  SETTLEMENT_CREATED
  SYSTEM_ANNOUNCEMENT
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Province {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  code         Int      @unique
  divisionType String   // "t·ªânh" or "th√†nh ph·ªë"
  codename     String   @unique
  phoneCode    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  trips        Trip[]
  tripTemplates TripTemplate[]

  @@index([code])
  @@index([divisionType])
}

model TripTemplate {
  id          String              @id @default(uuid()) @db.Uuid
  title       String
  description String?
  avatar      String?             // S3 URL for trip template avatar
  fee         Decimal             @default(0) @db.Decimal(20, 2)
  provinceId  String?             @db.Uuid
  isPublic    Boolean             @default(false)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  userId      String              @db.Uuid
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  province    Province?           @relation(fields: [provinceId], references: [id], onDelete: SetNull)
  days        TripTemplateDay[]

  @@index([provinceId])
  @@index([userId])
}

model TripTemplateDay {
  id          String                    @id @default(uuid()) @db.Uuid
  title       String
  description String?
  dayOrder    Int                       // Order of the day in the template
  tripTemplateId String                 @db.Uuid
  tripTemplate   TripTemplate           @relation(fields: [tripTemplateId], references: [id], onDelete: Cascade)
  activities     TripTemplateActivity[]

  @@index([tripTemplateId])
}

model TripTemplateActivity {
  id          String              @id @default(uuid()) @db.Uuid
  title       String
  startTime   String?              // Store as string (e.g., "09:00")
  durationMin Int?
  location    String?
  notes       String?
  important   Boolean              @default(false)
  activityOrder Int                // Order of the activity in the day
  dayId       String              @db.Uuid
  day         TripTemplateDay      @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
}


model Template {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique // e.g., 'trip_created', 'forgot_password', 'trip_invitation'
  title        String?           // Push/In-app title
  message      String?           // Push/In-app message
  emailSubject String?
  emailBody    String?           // Email HTML body
  icon         String?
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
