generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                String               @unique
  password             String?
  fullName             String?
  phoneNumber          String?
  profilePicture       String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  bankId               String?
  bankNumber           String?
  notificationsEnabled Boolean              @default(true)
  resetPasswordExpires DateTime?
  resetPasswordToken   String?
  devices              Device[]
  paidExpenses         Expense[]            @relation("ExpensePayer")
  expenseParticipants  ExpenseParticipant[]
  notifications        Notification[]
  creditorSettlements  PaymentSettlement[]  @relation("PaymentCreditor")
  debtorSettlements    PaymentSettlement[]  @relation("PaymentDebtor")
  transactionsFrom     PaymentTransaction[] @relation("TransactionsFromUser")
  transactionsTo       PaymentTransaction[] @relation("TransactionsToUser")
  socialAccounts       SocialAccount[]
  trips                Trip[]
  tripMembers          TripMember[]
  wishlistTemplates    TripTemplate[] @relation("UserWishlist")
}

model Trip {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title              String
  startDate          DateTime?
  description        String?
  shareToken         String?             @unique
  isPublic           Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime?           @updatedAt
  userId             String              @db.Uuid
  provinceId         String?             @db.Uuid
  templateId         String?             @db.Uuid
  avatar             String?
  days               Day[]
  expenses           Expense[]
  paymentSettlements PaymentSettlement[]
  province           Province?           @relation(fields: [provinceId], references: [id])
  template           TripTemplate?       @relation(fields: [templateId], references: [id])
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  members            TripMember[]

  @@index([provinceId])
  @@index([templateId])
}

model Day {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  date        DateTime
  startTime   DateTime?
  tripId      String     @db.Uuid
  activities  Activity[]
  trip        Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
}

model TripMember {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  joinedAt     DateTime  @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String?   @db.Uuid
  tripId       String    @db.Uuid
  inviteToken  String?   @unique
  invitedAt    DateTime?
  invitedById  String?   @db.Uuid
  status       String    @default("accepted")
  invitedEmail String?
  trip         Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user         User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tripId])
  @@index([invitedEmail, tripId])
}

model Activity {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  startTime   DateTime?
  durationMin Int?
  location    String?
  notes       String?
  important   Boolean   @default(false)
  sortOrder   Int       @default(0)
  dayId       String    @db.Uuid
  day         Day       @relation(fields: [dayId], references: [id], onDelete: Cascade)
  avatar      String?
}

model Expense {
  id           String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String
  amount       Decimal              @db.Decimal(20, 2)
  date         DateTime
  description  String?
  isLocked     Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  tripId       String               @db.Uuid
  payerId      String               @db.Uuid
  payer        User                 @relation("ExpensePayer", fields: [payerId], references: [id], onDelete: Cascade)
  trip         Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  participants ExpenseParticipant[]
}

model ExpenseParticipant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  expenseId String   @db.Uuid
  userId    String   @db.Uuid
  amount    Decimal  @db.Decimal(20, 2)
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([expenseId, userId])
}

model SocialAccount {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider   String
  providerId String
  email      String
  name       String?
  picture    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([provider, email])
}

model PaymentSettlement {
  id           String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  amount       Decimal              @db.Decimal(10, 2)
  status       String               @default("pending")
  description  String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  settledAt    DateTime?
  tripId       String               @db.Uuid
  debtorId     String               @db.Uuid
  creditorId   String               @db.Uuid
  creditor     User                 @relation("PaymentCreditor", fields: [creditorId], references: [id], onDelete: Cascade)
  debtor       User                 @relation("PaymentDebtor", fields: [debtorId], references: [id], onDelete: Cascade)
  trip         Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  transactions PaymentTransaction[]

  @@unique([tripId, debtorId, creditorId], name: "trip_debtor_creditor_unique")
}

model PaymentTransaction {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  amount       Decimal           @db.Decimal(10, 2)
  status       String            @default("success")
  method       String?
  note         String?
  createdAt    DateTime          @default(now())
  settlementId String            @db.Uuid
  fromUserId   String            @db.Uuid
  toUserId     String            @db.Uuid
  fromUser     User              @relation("TransactionsFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  settlement   PaymentSettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  toUser       User              @relation("TransactionsToUser", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([settlementId])
}

model Device {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String   @db.Uuid
  deviceId         String
  deviceName       String?
  userAgent        String?
  pushSubscription String?
  isActive         Boolean  @default(true)
  lastSeen         DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([userId])
}

model Notification {
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String             @db.Uuid
  title     String
  body      String
  type      NotificationType   @default(INFO)
  status    NotificationStatus @default(UNREAD)
  data      Json?
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([type])
}

model Province {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  code          Int            @unique
  divisionType  String
  codename      String         @unique
  phoneCode     Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  trips         Trip[]
  tripTemplates TripTemplate[]

  @@index([code])
  @@index([divisionType])
}

model TripTemplate {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  provinceId  String?           @db.Uuid
  isPublic    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  avatar      String?
  fee         Decimal           @default(0) @db.Decimal(20, 2)
  province    Province?         @relation(fields: [provinceId], references: [id])
  days        TripTemplateDay[]
  trips       Trip[]
  favoritedBy User[]            @relation("UserWishlist")

  @@index([provinceId])
}

model TripTemplateDay {
  id             String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title          String
  description    String?
  dayOrder       Int
  tripTemplateId String                 @db.Uuid
  activities     TripTemplateActivity[]
  tripTemplate   TripTemplate           @relation(fields: [tripTemplateId], references: [id], onDelete: Cascade)

  @@index([tripTemplateId])
}

model TripTemplateActivity {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  startTime     String?
  durationMin   Int?
  location      String?
  notes         String?
  important     Boolean         @default(false)
  activityOrder Int
  dayId         String          @db.Uuid
  day           TripTemplateDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
}

model Template {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique
  title        String?
  message      String?
  emailSubject String?
  emailBody    String?
  icon         String?
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Otp {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  type      OtpType
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email, type])
}

enum OtpType {
  FORGOT_PASSWORD
  VERIFY_EMAIL
  LOGIN
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  TRIP_CREATED
  TRIP_UPDATED
  TRIP_DELETED
  EXPENSE_ADDED
  EXPENSE_UPDATED
  SETTLEMENT_CREATED
  SYSTEM_ANNOUNCEMENT
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}
